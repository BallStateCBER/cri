var surveyInvitationForm={counter:1,already_invited:[],uninvited_respondents:[],cookieKey:"invitationFormData",cookieExpiration:365,rowLimit:20,init:function(e){this.counter=e.counter,this.already_invited=e.already_invited,this.uninvited_respondents=e.uninvited_respondents,this.addRow(!1),$("#add_another").click(function(e){e.preventDefault(),surveyInvitationForm.addRow(!0)}),$("#sent_invitations_toggler").click(function(e){e.preventDefault(),$("#sent_invitations").slideToggle()}),$("#suggestions_toggler").click(function(e){e.preventDefault(),$("#invitation_suggestions").slideToggle()}),$("#UserClientInviteForm").submit(function(e){var t=$(this);return t.find(".already_invited").length>0?(alert("Please remove any email addresses that have already been recorded before continuing."),e.preventDefault(),!1):(surveyInvitationForm.clearSavedData(),!0)}),Cookies.json=!0,$("#save").click(function(e){e.preventDefault(),surveyInvitationForm.save()}),Cookies.get(this.cookieKey)&&this.load()},addRow:function(){var e=$("#invitation_fields_template"),t=e.clone();t.attr("id",""),t.find("input[type=email], input[type=text]").each(function(){var e=$(this);e.prop("disabled",!1),e.attr("id",""),e.change(function(){var e=$(this),t=e.val().trim();e.val(t),"email"==e.attr("type")&&surveyInvitationForm.checkEmail(e)});var t=e.attr("name").replace("0",surveyInvitationForm.counter);e.attr("name",t)}),t.find("button.remove").click(function(){$(this).parents("tr").remove(),$("#add_another").is(":visible")||$("#add_another").show()}),this.counter++,$("#UserClientInviteForm tbody.input").append(t);var i=$("#UserClientInviteForm tbody.input tr").length;if(i>=this.rowLimit){if(0===$("#limit-warning").length){var n=$('<p id="limit-warning" class="alert alert-info"></p>');n.html("Sorry, at the moment only "+this.rowLimit+" invitations can be sent out at a time."),n.hide(),$("#UserClientInviteForm table").after(n),n.slideDown(500)}$("#add_another").hide()}},checkEmail:function(e){var t=e.val();if(""!==t){var i=e.closest(".form-inline");i.children(".error-message").remove();var n=null;this.isInvitedRespondent(t)?(n=$('<div class="error-message already_invited">An invitation has already been sent to '+t+"</div>"),i.append(n)):(n=e.parent("td").children(".error-message"),n.removeClass("already_invited"),n.slideUp(function(){$(this).remove()}))}},isInvitedRespondent:function(e){return-1!=this.already_invited.indexOf(e)},isUninvitedRespondent:function(e){return-1!=this.uninvited_respondents.indexOf(e)},save:function(){for(var e=$("#UserClientInviteForm tr"),t=[],i=0;i<e.length;i++){var n=$(e[i]).find('input[name*="[name]"]').val(),a=$(e[i]).find('input[name*="[email]"]').val(),s=$(e[i]).find('input[name*="[title]"]').val();if(""!==n||""!==a||""!==s){var o={name:n,email:a,title:s};t.push(o)}}Cookies.set(this.cookieKey,t,{expires:this.cookieExpiration}),$("#survey-invitation-save-status").html('<span id="invitation-form-loading" class="text-muted"><img src="/data_center/img/loading_small.gif" /> Saving...</span>'),setTimeout(function(){$("#survey-invitation-save-status").html('<span class="text-success">Saved</span>')},1e3),formProtector.setSaved("UserClientInviteForm")},load:function(){var e=Cookies.get(this.cookieKey);if(0!==e.length){$("#UserClientInviteForm tr").remove();for(var t=0;t<e.length;t++){this.addRow(!1);var i=e[t],n=$("#UserClientInviteForm > fieldset .form-inline:last-child");n.find('input[name*="[name]"]').val(i.name),n.find('input[name*="[email]"]').val(i.email),n.find('input[name*="[title]"]').val(i.title)}}},clearSavedData:function(){Cookies.remove(this.cookieKey)}},clientHome={init:function(){this.setupImport(),$(".importing_note_toggler").click(function(e){e.preventDefault();var t=$(this).closest("td").find(".importing_note");t.slideToggle()})},setupImport:function(){$(".import_button").click(function(e){e.preventDefault();var t=$(this);if(!t.hasClass("disabled")){var i=t.data("survey-id"),n=t.closest("tr");$.ajax({url:"/surveys/import/"+i,beforeSend:function(){t.addClass("disabled");var e=$('<img src="/data_center/img/loading_small.gif" class="loading" />');t.append(e)},success:function(e){var t=$('<p class="last_import alert alert-success" role="alert">'+e+"</p>");t.hide(),n.find(".last_import").slideUp(function(){$(this).remove()});var i=n.children("td:nth-child(2)");i.append(t),t.slideDown()},error:function(e,t,i){console.log(e),console.log(t),console.log(i);var a=$('<p class="last_import alert alert-danger" role="alert">There was an error checking for new responses.<br />Please try again or contact us for assistance.</p>');a.hide(),n.find(".last_import").slideUp(function(){$(this).remove()});var s=n.children("td:nth-child(2)");s.append(a),a.slideDown()},complete:function(){t.removeClass("disabled"),t.find(".loading").remove()}})}})}},unapprovedRespondents={init:function(){$("#toggle_dismissed").click(function(e){e.preventDefault(),$("#dismissed_respondents > div").slideToggle()}),$("a.approve, a.dismiss").click(function(e){e.preventDefault();var t=$(this);unapprovedRespondents.updateRespondent(t)})},updateRespondent:function(e){$.ajax({url:e.attr("href"),beforeSend:function(){e.addClass("disabled");var t=$('<img src="/data_center/img/loading_small.gif" class="loading" />');e.append(t),e.closest("td").find("p.text-danger, p.text-success, p.text-warning").slideUp()},success:function(t){var i=null;"success"==t?(e.hasClass("dismiss")?(i=$('<p class="text-warning">Dismissed</p>'),e.closest("tr").addClass("bg-warning")):(i=$('<p class="text-success">Approved</p>'),e.closest("tr").addClass("bg-success")),i.hide(),e.closest("td").append(i),e.closest("span.actions").slideUp(300,function(){i.slideDown()})):(i=$('<p class="text-danger">Error</p>'),e.closest("td").append(i))},error:function(e,t,i){console.log(e),console.log(t),console.log(i),alert("There was an error updating this respondent's status. Please try again or contact us for assistance.")},complete:function(){e.find(".loading").remove(),e.parent().children("a").removeClass("disabled")}})}};