var surveyInvitationForm={counter:1,already_invited:[],uninvited_respondents:[],cookieKey:"invitationFormData",cookieExpiration:365,rowLimit:20,surveyId:null,init:function(e){this.counter=e.counter,this.already_invited=e.already_invited,this.uninvited_respondents=e.uninvited_respondents,this.surveyId=e.surveyId,0===$("#UserClientInviteForm tbody.input tr").length&&this.addRow(),$("#add_another").click(function(e){e.preventDefault(),surveyInvitationForm.addRow()}),$("#sent_invitations_toggler").click(function(e){e.preventDefault(),$("#sent_invitations").slideToggle()}),$("#suggestions_toggler").click(function(e){e.preventDefault(),$("#invitation_suggestions").slideToggle()}),$("#UserClientInviteForm").submit(function(e){return!($(this).find(".already_invited").length>0&&(alert("Please remove any email addresses that have already been recorded before continuing."),e.preventDefault(),1))}),$("#UserClientInviteForm button.remove").click(function(){surveyInvitationForm.removeRow($(this).parents("tr"))}),$("#show-spreadsheet-modal").click(function(e){e.preventDefault()}),$("#clear-data").click(function(e){e.preventDefault();var t=$(this),n=$("#clear-data-results");$.ajax({url:"/surveys/clear-saved-invitation-data/"+surveyInvitationForm.surveyId,dataType:"json",beforeSend:function(){t.addClass("disabled");var e=$('<img src="/data_center/img/loading_small.gif" class="loading" />');t.append(e),n.is(":visible")&&n.hide()},success:function(e){n.attr("class","text-success"),n.html('<span class="glyphicon glyphicon-ok"></span> Saved data cleared'),n.fadeIn(200)},error:function(e,t,i){n.attr("class","text-danger"),n.html('<span class="glyphicon glyphicon-warning-sign"></span> Error clearing data'),n.fadeIn(200)},complete:function(){t.removeClass("disabled"),t.find(".loading").remove()}})}),formProtector.protect("UserClientInviteForm",{ignore:["spreadsheet-upload-input"]}),$("#toggle-upload").click(function(e){e.preventDefault(),$("#upload-container").slideToggle(300)}),$("#spreadsheet-upload").fileupload({dataType:"json",url:"/client/surveys/upload-invitation-spreadsheet/"+this.surveyId,add:function(e,t){$("#upload-progress").slideDown(200);var n=$('<img src="/data_center/img/loading_small.gif" alt="(loading...)" />');$("#toggle-upload").prepend(n).addClass("disabled");var i=$("#upload-result");i.is(":visible")&&i.slideUp(300),t.submit()},progressall:function(e,t){var n=parseInt(t.loaded/t.total*100,10);$("#upload-progress .progress-bar").css("width",n+"%").html(n+"%")},done:function(e,t){if(surveyInvitationForm.uploadDone(),0===t.result.data.length)surveyInvitationForm.displayUploadResult("No invitation information found in spreadsheet","alert alert-danger");else{surveyInvitationForm.insertSpreadsheetData(t.result.data);var n=t.result.message;surveyInvitationForm.displayUploadResult(n,"alert alert-success")}console.log(t.result)},error:function(e,t,n){surveyInvitationForm.uploadDone();var i="";try{var s=JSON.parse(e.responseText);i=s.message}catch(e){i="There was an error reading that spreadsheet."}surveyInvitationForm.displayUploadResult(i,"alert alert-danger")}})},insertSpreadsheetData:function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.hasOwnProperty("name")&&n.hasOwnProperty("email")&&n.hasOwnProperty("title")){this.lastRowIsBlank()||this.addRow();var i=$("#UserClientInviteForm tbody.input tr:last-child");i.find('input[name*="[name]"]').val(n.name),i.find('input[name*="[email]"]').val(n.email),i.find('input[name*="[title]"]').val(n.title)}}formProtector.protect("UserClientInviteForm",{ignore:["spreadsheet-upload-input"]})},uploadDone:function(){$("#upload-progress").slideUp(200);var e=$("#toggle-upload");e.removeClass("disabled"),e.find("img").remove()},displayUploadResult:function(e,t){var n=$("#upload-result"),i=function(){n.attr("class",t),n.html(e),n.slideDown(300)};n.is(":visible")?n.slideUp(300,i):i()},addRow:function(){var e=$("#invitation_fields_template"),t=e.clone();if(t.attr("id",""),t.find("input[type=email], input[type=text]").each(function(){var e=$(this);e.prop("disabled",!1),e.attr("id",""),e.change(function(){var e=$(this),t=e.val().trim();e.val(t),"email"==e.attr("type")&&surveyInvitationForm.checkEmail(e)});var t=e.attr("name").replace("0",surveyInvitationForm.counter);e.attr("name",t)}),t.find("button.remove").click(function(){surveyInvitationForm.removeRow($(this).parents("tr"))}),this.counter++,$("#UserClientInviteForm tbody.input").append(t),$("#UserClientInviteForm tbody.input tr").length>=this.rowLimit){if(0===$("#limit-warning").length){var n=$('<p id="limit-warning" class="alert alert-info"></p>');n.html("Sorry, at the moment only "+this.rowLimit+" invitations can be sent out at a time."),n.hide(),$("#UserClientInviteForm table").after(n),n.slideDown(500)}$("#add_another").hide()}formProtector.protect("UserClientInviteForm",{ignore:["spreadsheet-upload-input"]})},removeRow:function(e){e.remove(),$("#add_another").is(":visible")||$("#add_another").show(),$("#UserClientInviteForm tbody.input tr").length<this.rowLimit&&$("#limit-warning").slideUp(function(){$(this).remove()})},checkEmail:function(e){var t=e.val();if(""!==t){var n=e.closest("td");n.children(".error-message").remove();var i=null;this.isInvitedRespondent(t)?(i=$('<div class="error-message already_invited">An invitation has already been sent to '+t+"</div>"),n.append(i)):(i=e.parent("td").children(".error-message"),i.removeClass("already_invited"),i.slideUp(function(){$(this).remove()}))}},isInvitedRespondent:function(e){return this.already_invited.indexOf(e)!=-1},isUninvitedRespondent:function(e){return this.uninvited_respondents.indexOf(e)!=-1},lastRowIsBlank:function(){var e=$("#UserClientInviteForm tbody.input tr:last-child");return""===e.find('input[name*="[name]"]').val()&&(""===e.find('input[name*="[email]"]').val()&&""===e.find('input[name*="[title]"]').val())}},clientHome={init:function(){this.setupImport(),this.setupToggledContainers(),this.setupConfirmationButtons(),$(".importing_note_toggler").click(function(e){e.preventDefault(),$(this).closest("td").find(".importing_note").slideToggle()})},setupImport:function(){$(".import-results").each(function(){var e=$(this);if(e.is(":empty"))e.hide();else{var t=e.find("ul"),n=$('<button class="btn btn-default btn-sm">Show</button>');n.click(function(e){e.preventDefault(),t.slideToggle()}),t.before(n),t.hide()}}),$(".import_button").click(function(e){e.preventDefault();var t=$(this);if(!t.hasClass("disabled")){var n=t.data("survey-id"),i=t.closest("tr"),s=i.find(".import-results");$.ajax({url:"/surveys/import/"+n,beforeSend:function(){t.addClass("disabled");var e=$('<img src="/data_center/img/loading_small.gif" class="loading" />');t.append(e),s.is(":visible")&&s.slideUp(200)},success:function(e){s.attr("class","import-results alert alert-success"),s.html(e),s.slideDown()},error:function(e,t,n){s.attr("class","import-results alert alert-danger"),s.html(e.responseText),s.slideDown()},complete:function(){t.removeClass("disabled"),t.find(".loading").remove()}})}})},setupToggledContainers:function(){$("#client_home > table > tbody").each(function(){var e=$(this),t=e.find("button.step-header"),n=e.find("tr").not(":first-child");n.length>0&&(t.attr("title","Click for details"),e.hasClass("current")||(n.hide(),t.addClass("closed"))),t.click(function(e){e.preventDefault(),0!==n.length&&(n.toggle(),t.toggleClass("closed"))})})},setupConfirmationButtons:function(){$(".opt-out").click(function(e){confirm("Are you sure you want to permanently opt out of this part of the Community Readiness Initiative?")||e.preventDefault()})}},unapprovedRespondents={currentBulkAction:null,init:function(){$("#toggle_dismissed").click(function(e){e.preventDefault(),$("#dismissed_respondents > div").slideToggle()}),$("a.approve, a.dismiss").click(function(e){e.preventDefault();var t=$(this);unapprovedRespondents.updateRespondent(t)}),this.setupBulkAction()},setupBulkAction:function(){$("#bulk-actions button").click(function(e){e.preventDefault();var t=$(this),n=$('<img src="/data_center/img/loading_small.gif" class="loading" />');t.append(n),unapprovedRespondents.currentBulkAction=t.data("action"),t.addClass("disabled"),t.siblings("button").addClass("disabled"),$("a."+t.data("action")).each(function(){var e=$(this);e.is(":visible")&&unapprovedRespondents.updateRespondent(e)})})},checkBulkActionsComplete:function(){if(this.currentBulkAction){0===$("a."+this.currentBulkAction+".disabled").length&&($("#bulk-actions").slideUp(1e3,function(){$("#bulk-actions").remove()}),this.currentBulkAction=null)}},updateRespondent:function(e){$.ajax({url:e.attr("href"),beforeSend:function(){e.addClass("disabled");var t=$('<img src="/data_center/img/loading_small.gif" class="loading" />');e.append(t),e.closest("td").find("p.text-danger, p.text-success, p.text-warning").slideUp()},success:function(t){var n=null;"success"==t?(e.hasClass("dismiss")?(n=$('<p class="text-warning">Dismissed</p>'),e.closest("tr").addClass("bg-warning")):(n=$('<p class="text-success">Approved</p>'),e.closest("tr").addClass("bg-success")),n.hide(),e.closest("td").append(n),e.closest("span.actions").slideUp(300,function(){n.slideDown()})):(n=$('<p class="text-danger">Error</p>'),e.closest("td").append(n))},error:function(e,t,n){console.log(e),console.log(t),console.log(n),alert("There was an error updating this respondent's status. Please try again or contact us for assistance.")},complete:function(){e.find(".loading").remove(),e.parent().children("a").removeClass("disabled"),unapprovedRespondents.checkBulkActionsComplete()}})}};