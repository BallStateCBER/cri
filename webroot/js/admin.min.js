function getRandomPassword(){for(var e="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;5>i;i++)e+=n.charAt(Math.floor(Math.random()*n.length));return e}var adminUserEdit={community_counter:0,init:function(e){var n=$('<ul id="community_container"></ul>'),i=$("#community");if(i.after(n),i.prop("selectedIndex",0),e.selected_communities.length>0)for(var t=0;t<e.selected_communities.length;t++){var s=e.selected_communities[t];this.addCommunity(s.id,s.name,!1)}i.change(function(){var e=$(this),n=e.val(),i=$('li[data-community-id="'+n+'"]');if(0===i.length){var t=e.find("option:selected").text();adminUserEdit.addCommunity(n,t,!0)}e.prop("selectedIndex",0)}),$("#all-communities-0, #all-communities-1").change(function(){adminUserEdit.toggleAllCommunities(!0)}),this.toggleAllCommunities(!1),$("#role").change(function(){adminUserEdit.onRoleChange(!0)}),this.onRoleChange(!1),$("#password-fields-button a").click(function(e){e.preventDefault(),$("#password-fields-button").slideUp(300),$("#password-fields").slideDown(300)})},addCommunity:function(e,n,i){var t=$('<li data-community-id="'+e+'"></li>'),s=$('<a href="#"><span class="glyphicon glyphicon-remove"></span> <span class="link_label">'+n+"</span></a>");s.click(function(e){e.preventDefault(),t.slideUp(300,function(){t.remove()})}),t.append(s),t.append('<input type="hidden" name="consultant_communities['+this.community_counter+'][id]" value="'+e+'" />'),this.community_counter++,i&&t.hide(),$("#community_container").prepend(t),i&&t.slideDown()},toggleAllCommunities:function(e){$("#all-communities-0").is(":checked")?e?($("#community").slideDown(),$("#community_container").slideDown()):($("#community").show(),$("#community_container").show()):e?($("#community").slideUp(),$("#community_container").slideUp()):($("#community").hide(),$("#community_container").hide())},onRoleChange:function(e){var n=$("#role").val(),i=e?300:0;"consultant"==n?($("#consultant_communities").slideDown(i),$("#client_communities").slideUp(i)):"client"==n?($("#client_communities").slideDown(i),$("#consultant_communities").slideUp(i)):($("#consultant_communities").slideUp(i),$("#client_communities").slideUp(i))}},communityForm={community_id:null,init:function(e){this.community_id=e.community_id,$("#meeting-date-set-0, #meeting-date-set-1").change(function(){communityForm.toggleDateFields(!0)}),this.toggleDateFields(!1)},toggleDateFields:function(e){$("#meeting-date-set-0").is(":checked")&&(e?$("#meeting_date_fields").slideUp():$("#meeting_date_fields").hide()),$("#meeting-date-set-1").is(":checked")&&(e?$("#meeting_date_fields").slideDown():$("#meeting_date_fields").show())}},adminSurveysIndex={init:function(){$("#surveys_admin_index .help_toggler").click(function(e){e.preventDefault(),$("#surveys_admin_index .help_message").slideToggle()})}},adminViewResponses={init:function(){$("#admin_responses_view .respondent_popup_handle").click(function(e){e.preventDefault(),$(this).siblings(".respondent_popup").toggle()}),$(".custom_alignment_calc").change(function(){var e=$("tfoot td.selected"),n=0,i=$(".custom_alignment_calc:checked");i.each(function(){var e=$(this).data("alignment");n=e+n});var t=i.length,s=t?Math.round(n/t):0;e.html(s+"%")}),$("#toggle_custom_calc").click(function(e){e.preventDefault(),$("td.selected, th.selected").toggle()})}},adminCommunitiesIndex={init:function(){$("a.survey_link_toggler").click(function(e){e.preventDefault(),$(this).siblings(".survey_links").slideToggle(200)}),$("#search_toggler").click(function(e){e.preventDefault();var n=$("#admin_community_search_form");n.is(":visible")?n.slideUp():(n.slideDown(),n.children("input").focus())}),$('#admin_community_search_form input[type="text"]').autocomplete({source:"/communities/autocomplete",minLength:2,select:function(e,n){$('#admin_community_search_form input[type="text"]').val(n.item.label);var i=' <img src="/data_center/img/loading_small.gif" class="loading" />';$("#admin_community_search_form button").append(i).addClass("disabled"),$("#admin_community_search_form").submit()},search:function(e,n){if(0===$("#admin_community_search_form .loading").length){var i='<img src="/data_center/img/loading_small.gif" class="loading" alt="loading" />';$("#admin_community_search_form button").after(i)}},response:function(e,n){$("#admin_community_search_form .loading").remove()}}),$("#glossary_toggler").click(function(e){e.preventDefault(),$("#glossary").slideToggle()})}},adminPurchasesIndex={init:function(){$("a.refunded, a.details").click(function(e){e.preventDefault(),$(this).closest("tr").next("tr.details").find("ul").slideToggle()})}},surveyOverview={community_id:null,init:function(e){this.community_id=e.community_id,this.setupImport(),this.setupSurveyLinking(),$(".invitations_toggler").click(function(e){e.preventDefault(),$(this).closest("div.panel-body").find(".invitations_list").slideToggle()})},setupImport:function(){$(".import_button").click(function(e){e.preventDefault();var n=$(this);if(!n.hasClass("disabled")){var i=n.data("survey-id");$.ajax({url:"/surveys/import/"+i,beforeSend:function(){n.addClass("disabled");var e=$('<img src="/data_center/img/loading_small.gif" class="loading" />');n.append(e)},success:function(e){var i=$('<div class="alert alert-success alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span></button>'+e+"</div>");i.hide(),n.before(i),i.slideDown()},error:function(e,n,i){console.log(e),console.log(n),console.log(i)},complete:function(){n.removeClass("disabled"),n.find(".loading").remove(),n.parent().children(".last_import_time").html("Responses were last imported a moment ago")}})}})},setupSurveyLinking:function(){$(".link_survey").each(function(){var e=$(this);e.find("a.lookup").click(function(n){n.preventDefault();var i=e.find(".lookup_results");i.is(":visible")?i.slideUp():surveyOverview.lookupUrl(e)}),e.find("a.show_details").click(function(n){n.preventDefault(),e.find(".details").slideToggle()})})},lookupUrl:function(e){var n=e.find("a.lookup"),i="/surveys/get_survey_list",t=e.find(".lookup_results");$.ajax({url:i,beforeSend:function(){n.addClass("disabled");var e=$('<img src="/data_center/img/loading_small.gif" alt="Loading..." />');n.append(e)},success:function(n){function i(n){return function(n){n.preventDefault();var i=$(this).data("survey-id"),t=$(this).data("survey-url");surveyOverview.checkSurveyAssignment(e,i,function(){surveyOverview.setQnaIds(e,i,function(){surveyOverview.selectSurvey(e,i,t)})})}}if(n=jQuery.parseJSON(n),t.empty(),0===n.length)return void t.append('<p class="alert alert-danger">Error: No surveys found</p>');t.append("<p>Please select the correct SurveyMonkey survey:</p>");for(var s=$("<ul></ul>"),a=0;a<n.length;a++){var l=n[a].sm_id,r=n[a].url,o=n[a].title,c=$('<a href="#" data-survey-id="'+l+'" data-survey-url="'+r+'">'+o+"</a>");c.click(i());var u=$("<li></li>").append(c);s.append(u)}t.append(s),t.slideDown()},error:function(){var e='<p class="alert alert-danger">Error: No surveys found</p>';t.is(":visible")?t.slideUp(300,function(){t.html(e),t.slideDown(300)}):(t.html(e),t.slideDown(300))},complete:function(){n.removeClass("disabled"),n.children("img").remove()}})},checkSurveyAssignment:function(e,n,i){var t=(e.find("input.survey_url"),e.find(".link_label")),s=e.find(".link_status");$.ajax({url:"/surveys/check_survey_assignment/"+n,dataType:"json",beforeSend:function(){var e='<span class="loading"><img src="/data_center/img/loading_small.gif" /> Checking survey uniqueness...</span>';t.html(e)},success:function(e){null===e||e.id==surveyOverview.community_id?(t.html(" "),i()):(t.html('<span class="label label-danger">Error</span>'),s.html('<span class="url_error">That survey is already assigned to another community: <a href="/admin/communities/edit/'+e.id+'">'+e.name+"</a></span>"))},error:function(a,l,r){t.html('<span class="label label-danger">Error</span>'),s.html('<span class="url_error">Error checking survey uniqueness</span>');var o=$('<a href="#" class="retry">Retry</a>');o.click(function(t){t.preventDefault(),surveyOverview.checkSurveyAssignment(e,n,i)}),s.append(o)}})},setQnaIds:function(e,n,i){var t=e.find(".link_label"),s=function(s){var a=e.find(".link_status"),l=$('<a href="#" class="retry">Retry</a>');l.click(function(t){t.preventDefault(),surveyOverview.setQnaIds(e,n,i)}),t.html('<span class="label label-danger">Error</span>'),a.html('<span class="url_error">'+s+"</span>"),a.append(l)};$.ajax({url:"/surveys/get_qna_ids/"+n,beforeSend:function(){var e='<span class="loading"><img src="/data_center/img/loading_small.gif" /> Extracting PWR<sup>3</sup> question info...</span>';t.html(e)},success:function(n){n=jQuery.parseJSON(n);var t=n[0];if(t){var a=n[2];for(var l in a){var r=e.find("input[data-fieldname='"+l+"']"),o=a[l];r.val(o)}i()}else{var c=n[1];s(c)}},error:function(e,n,i){s("Error extracting PWR<sup>3</sup> question info")},complete:function(){e.find(".loading").remove()}})},selectSurvey:function(e,n,i){var t=e.find(".lookup_results");t.is(":visible")&&t.slideUp(),e.find(".url_error, .retry").remove();var s=e.find("input.survey_sm_id");s.val(n);var a=e.find("input.survey_url"),l=e.find(".link_label"),r=e.find(".link_status");return i?(a.val(i),l.html('<span class="glyphicon glyphicon-ok" aria-hidden="true"></span>'),void r.html('<p>Survey URL: <a href="'+i+'">'+i+"</a></p>")):(a.val(""),void $.ajax({url:"/surveys/get_survey_url/"+n,beforeSend:function(){a.prop("disabled",!0);var e='<span class="loading"><img src="/data_center/img/loading_small.gif" /> Retrieving URL...</span>';l.html(e)},success:function(e){a.val(e),l.html('<span class="label label-success">Linked</span>'),r.html('<a href="'+e+'">'+e+"</a>")},error:function(t,s,a){l.html('<span class="label label-danger">Error</span>');var o=-1!=t.responseText.indexOf(o)?'<span class="url_error">No URL found for this survey. Web link collector may not be configured yet.</span>':'<span class="url_error">Error looking up URL</span>';r.html(o);var c=$('<a href="#" class="retry">Retry</a>');c.click(function(t){t.preventDefault(),surveyOverview.checkSurveyAssignment(e,n,function(){surveyOverview.setQnaIds(e,n,function(){surveyOverview.selectSurvey(e,n,i)})})}),r.append(c)},complete:function(){a.prop("disabled",!1),e.find(".loading").remove()}}))}};