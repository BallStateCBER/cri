function getRandomPassword(){for(var e="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=0;t<5;t++)e+=n.charAt(Math.floor(Math.random()*n.length));return e}function compareNumbers(e,n){var t=$.isNumeric(e),i=$.isNumeric(e);return t&&i?e-n:t||i?t&&!i?1:-1:e>n?1:-1}var adminUserEdit={community_counter:0,init:function(e){var n=$('<ul id="community_container"></ul>'),t=$("#community");if(t.after(n),t.prop("selectedIndex",0),e.selected_communities.length>0)for(var i=0;i<e.selected_communities.length;i++){var s=e.selected_communities[i];this.addCommunity(s.id,s.name,!1)}t.change(function(){var e=$(this),n=e.val();if(0===$('li[data-community-id="'+n+'"]').length){var t=e.find("option:selected").text();adminUserEdit.addCommunity(n,t,!0)}e.prop("selectedIndex",0)}),$("#all-communities-0, #all-communities-1").change(function(){adminUserEdit.toggleAllCommunities(!0)}),this.toggleAllCommunities(!1),$("#role").change(function(){adminUserEdit.onRoleChange(!0)}),this.onRoleChange(!1),$("#password-fields-button button").click(function(e){e.preventDefault(),$("#password-fields-button").slideUp(300),$("#password-fields").slideDown(300)})},addCommunity:function(e,n,t){var i=$('<li data-community-id="'+e+'"></li>'),s='<span class="glyphicon glyphicon-remove"></span> <span class="link_label">'+n+"</span>",a=$('<a href="#">'+s+"</a>");a.click(function(e){e.preventDefault(),i.slideUp(300,function(){i.remove()})}),i.append(a);var r='<input type="hidden" name="consultant_communities['+this.community_counter+'][id]" value="'+e+'" />';i.append(r),this.community_counter++,t&&i.hide(),$("#community_container").prepend(i),t&&i.slideDown()},toggleAllCommunities:function(e){$("#all-communities-0").is(":checked")?e?($("#community").slideDown(),$("#community_container").slideDown()):($("#community").show(),$("#community_container").show()):e?($("#community").slideUp(),$("#community_container").slideUp()):($("#community").hide(),$("#community_container").hide())},onRoleChange:function(e){var n=$("#role").val(),t=e?300:0;"consultant"==n?($("#consultant_communities").slideDown(t),$("#client_communities").slideUp(t)):"client"==n?($("#client_communities").slideDown(t),$("#consultant_communities").slideUp(t)):($("#consultant_communities").slideUp(t),$("#client_communities").slideUp(t))}},communityForm={community_id:null,areaTypes:null,init:function(e){this.community_id=e.community_id,this.areaTypes=e.areaTypes,$("#meeting-date-set-0, #meeting-date-set-1").change(function(){communityForm.toggleDateFields(!0)}),this.toggleDateFields(!1),this.setupAreaSelection()},toggleDateFields:function(e){$("#meeting-date-set-0").is(":checked")&&(e?$("#meeting_date_fields").slideUp():$("#meeting_date_fields").hide()),$("#meeting-date-set-1").is(":checked")&&(e?$("#meeting_date_fields").slideDown():$("#meeting_date_fields").show())},setupAreaSelection:function(){$("#local-area-id, #parent-area-id").each(function(){for(var e=$(this),n=$('<select class="form-control"></select>'),t=0;t<communityForm.areaTypes.length;t++){var i=communityForm.areaTypes[t];n.append('<option value="'+i+'">'+i+"</option>")}e.before(n),n.change(function(n){var t=$(this).val();communityForm.changeAreaType(e,t)});var s=e.find("option:selected"),a="";a=0===s.length||""===s.val()?"parent-area-id"==e.attr("id")?"County":"City":s.parent("optgroup").attr("label"),n.find('option[value="'+a+'"]').prop("selected",!0),communityForm.changeAreaType(e,a)})},changeAreaType:function(e,n){e.find('optgroup[label="'+n+'"]').show(),e.find("optgroup").not('[label="'+n+'"]').hide()}},adminSurveysIndex={init:function(){$("#surveys_admin_index .help_toggler").click(function(e){e.preventDefault(),$("#surveys_admin_index .help_message").slideToggle()})}},adminViewResponses={init:function(){this.setupAlignmentTable(),this.setupUpdateAlignment()},setupAlignmentTable:function(){$(".custom_alignment_calc").change(function(){var e=$(this).closest(".responses");adminViewResponses.updateAlignment(e),adminViewResponses.updateRespondentCount(e)}),$(".calc-mode").change(function(e){e.preventDefault();var n=$(this).closest(".responses"),t=$(this).val();n.find("td.selected, th.selected").toggle("selected"==t),adminViewResponses.updateRespondentCount(n),adminViewResponses.updateAlignment(n)});var e='<span class="glyphicon glyphicon-user"></span>',n={show:e+" Show respondent info",hide:e+" Hide respondent info"};$("#show-respondents").html(n.show).click(function(e){e.preventDefault();var t=$(this);"show"==t.data("label")?($("tr.respondent").show(),t.data("label","hide"),t.html(n.hide)):($("tr.respondent").hide(),t.data("label","show"),t.html(n.show))}),$("tr.respondent").hide(),$("ul.nav-tabs li[role=presentation]").first().find("a").tab("show");var t={fullscreen:'<span class="glyphicon glyphicon-fullscreen"></span> <span class="text">Show table full size</span>',window:'<span class="glyphicon glyphicon-list-alt"></span> <span class="text">Show table in window</span>'};$("#toggle-table-scroll").html(t.fullscreen).data("mode","scrolling").click(function(e){e.preventDefault();var n=$(this),i=$("#admin-responses-view .tab-pane > .responses > div");"scrolling"==n.data("mode")?(i.removeClass("scrollable_table"),n.html(t.window),n.data("mode","fullscreen")):(i.addClass("scrollable_table"),n.html(t.fullscreen),n.data("mode","scrolling"))}),$(".full-response-button").click(function(e){var n=$(this),t=n.data("respondent-id");adminViewResponses.showFullResponse(t)})},showFullResponse:function(e){$.ajax({url:"/admin/responses/get-full-response/"+e,dataType:"json",beforeSend:function(e){var n=$("#full-response-modal");n.find(".modal-body").html('Loading... <img src="/data_center/img/loading_small.gif" />'),n.modal()},success:function(e,n,t){var i=$("#full-response-modal"),s=i.find(".modal-body");s.html("");var a=e.response;for(var r in a){s.append("<h3>"+r+"</h3>");for(var o=$("<ul></ul>"),l=a[r],d=0;d<l.length;d++)o.append("<li>"+l[d]+"</li>");s.append(o)}},error:function(e,n,t){var i=$.parseJSON(e.responseText),s="";s=i.hasOwnProperty("message")?i.message:"There was an error loading that response",$("#full-response-modal .modal-body").html('<span class="text-danger">'+s+"</span>")}})},updateAlignment:function(e){var n=[];n="selected"==this.getCalcMode(e)?e.find(".custom_alignment_calc:checked"):e.find("td.approved .glyphicon-ok");var t=0;n.each(function(){var e=$(this).closest("tr").data("alignment");t=e+t});var i=n.length,s=i?Math.round(t/i):0;e.find("span.total_alignment").html(s+"%")},getRespondentCount:function(e){return"selected"==this.getCalcMode(e)?e.find("input.custom_alignment_calc:checked").length:e.find("td.approved .glyphicon-ok").length},updateRespondentCount:function(e){var n=adminViewResponses.getRespondentCount(e);e.find(".respondent_count").html(n);var t=e.find(".respondent_plurality");t.html("respondent"),1!=n&&t.append("s")},getCalcMode:function(e){return e.find(".calc-mode").val()},setupUpdateAlignment:function(){$("#update-alignment").click(function(e){e.preventDefault();var n=$(this);$.ajax({url:n.data("update-url"),beforeSend:function(){n.addClass("disabled");var e=$('<img src="/data_center/img/loading_small.gif" alt="Loading..." />');n.append(e)},success:function(e){var t=n.closest(".alert");t.fadeOut(300,function(){t.removeClass("alert-danger"),t.addClass("alert-success"),t.html("Alignment data saved. ");var e=$('<button class="btn btn-default btn-sm">Refresh this page</button>');e.click(function(){location.reload()}),t.append(e),t.fadeIn()})},error:function(){$("There was an error updating this community's alignment score").insertAfter(n)},complete:function(){n.removeClass("disabled"),n.children("img").remove()}})})}},adminCommunitiesIndex={init:function(){$("a.survey_link_toggler").click(function(e){e.preventDefault(),$(this).siblings(".survey_links").slideToggle(200)}),$("#search_toggler").click(function(e){e.preventDefault();var n=$("#admin_community_search_form");if(n.is(":visible"))n.slideUp(200),adminCommunitiesIndex.filter("");else{n.slideDown(200),n.children("input").focus();var t=$('#admin_community_search_form input[type="text"]').val();adminCommunitiesIndex.filter(t)}}),$('#admin_community_search_form input[type="text"]').bind("change paste keyup",function(){var e=$(this).val();adminCommunitiesIndex.filter(e)})},filter:function(e){if(""===e)return void $("table.communities tbody tr").show();$("table.communities tbody tr").each(function(){var n=$(this),t=n.data("community-name").toLowerCase();e=e.toLowerCase(),t.search(e)==-1?n.hide():n.show()})}},adminPurchasesIndex={init:function(){$("button.refunded, button.details").click(function(e){e.preventDefault(),$(this).closest("tr").next("tr.details").find("ul").slideToggle()})}},surveyLink={community_id:null,survey_type:null,init:function(e){this.community_id=e.community_id,this.survey_type=e.type,this.setupSurveyLinking(),1===$("#survey-link-buttons").data("is-new")&&$("#survey-link-submit").prop("disabled",!0)},setupSurveyLinking:function(){$(".link_survey").each(function(){var e=$(this);e.find("button.lookup").click(function(n){n.preventDefault();var t=e.find(".lookup_results");t.is(":visible")?t.slideUp():surveyLink.lookupUrl(e)}),e.find("button.show_details").click(function(n){n.preventDefault(),e.find(".details").slideToggle()})})},lookupUrl:function(e){var n=e.find("button.lookup"),t=e.find(".lookup_results");$.ajax({url:"/surveys/get_survey_list",beforeSend:function(){n.addClass("disabled");var e=$('<img src="/data_center/img/loading_small.gif" alt="Loading..." />');n.append(e)},success:function(n){if(n=jQuery.parseJSON(n),t.empty(),0===n.length)return t.append('<p class="alert alert-info">No questionnaires found</p>'),void t.slideDown();t.append("<p>Please select the correct SurveyMonkey questionnaire:</p>");for(var i=$("<ul></ul>"),s=0;s<n.length;s++){var a=n[s].sm_id,r=n[s].url,o=n[s].title,l=$('<a href="#" data-survey-id="'+a+'" data-survey-url="'+r+'">'+o+"</a>");l.click(function(n){return function(n){n.preventDefault();var t=$(this).data("survey-id"),i=$(this).data("survey-url");surveyLink.checkSurveyAssignment(e,t,function(){surveyLink.setQnaIds(e,t,function(){surveyLink.selectSurvey(e,t,i)})})}}());var d=$("<li></li>").append(l);i.append(d)}t.append(i),t.slideDown()},error:function(){var e='<p class="alert alert-danger">Error: No questionnaires found</p>';t.is(":visible")?t.slideUp(300,function(){t.html(e),t.slideDown(300)}):(t.html(e),t.slideDown(300))},complete:function(){n.removeClass("disabled"),n.children("img").remove()}})},checkSurveyAssignment:function(e,n,t){var i=($("#sm-url"),$(".loading_messages"));$.ajax({url:"/surveys/check_survey_assignment/"+n,dataType:"json",beforeSend:function(){var e='<img src="/data_center/img/loading_small.gif" /> Checking questionnaire uniqueness...';e='<span class="loading">'+e+"</span>",i.html(e)},success:function(e){var n,s=function(e){e='<span class="label label-danger">Error</span><p class="url_error">'+e+"</p>",$(".loading_messages").html(e)};null===e?(i.html(" "),t()):e.id!=surveyLink.community_id?(n="That questionnaire is already assigned to another community: ",n+='<a href="/admin/communities/edit/'+e.id+'">'+e.name+"</a>",s(n)):e.type!=surveyLink.survey_type?(n="That questionnaire is already linked as this community's community ",n+=e.type+"s questionnaire.",s(n)):(i.html(" "),t())},error:function(s,a,r){var o='<span class="label label-danger">Error</span> Error checking questionnaire uniqueness. ';o='<p class="url_error">'+o+"</p>",i.html(o);var l=$('<a href="#" class="retry">Retry</a>');l.click(function(i){i.preventDefault(),surveyLink.checkSurveyAssignment(e,n,t)}),i.find("p").append(l)}})},setQnaIds:function(e,n,t){var i=e.find(".loading_messages"),s=function(s){var a=$('<a href="#" class="retry">Retry</a>');a.click(function(i){i.preventDefault(),surveyLink.setQnaIds(e,n,t)});var r='<p class="url_error"><span class="label label-danger">Error</span> '+s+" </p>";i.html(r),i.find("p").append(a)};$.ajax({url:"/surveys/get_qna_ids/"+n,beforeSend:function(){var e="Extracting PWR<sup>3</sup> question info...";e='<span class="loading"><img src="/data_center/img/loading_small.gif" /> '+e+"</span>",i.html(e)},success:function(n){if(n=jQuery.parseJSON(n),n[0]){var i=n[2],a=["aware_of_plan_qid","aware_of_city_plan_aid","aware_of_county_plan_aid","aware_of_regional_plan_aid","unaware_of_plan_aid"],r=surveyLink.getSurveyType();for(var o in i){var l=e.find("input[data-fieldname='"+o+"']"),d=i[o];if("official"==r||a.indexOf(o)==-1){if(!d)return void s("This questionnaire is missing a question or answer ID ("+o+")");l.val(d)}}t()}else{var c=n[1];s(c)}},error:function(e,n,t){s("Error extracting PWR<sup>3</sup> question info")},complete:function(){e.find(".loading").remove()}})},getSurveyType:function(){return $("#surveyType").val()},selectSurvey:function(e,n,t){var i=e.find(".lookup_results");i.is(":visible")&&i.slideUp(),e.find(".url_error, .retry").remove(),$("#survey-link-submit").prop("disabled",!1),$("#sm-id").val(n);var s=$("#sm-url"),a=e.find(".link_status"),r=e.find("span.survey_url"),o='<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span> ';if(o+="Ready to be linked",o='<span class="text-warning">'+o+"</span>",t)return s.val(t),a.html(o),void r.html('<a href="'+t+'">'+t+"</a>");s.val("");var l=$(".loading_messages");$.ajax({url:"/surveys/get_survey_url/"+n,beforeSend:function(){s.prop("disabled",!0);var e='<img src="/data_center/img/loading_small.gif" /> Retrieving URL...';e='<span class="loading">'+e+"</span>",l.html(e)},success:function(e){s.val(e),a.html(o),r.html('<a href="'+e+'">'+e+"</a>")},error:function(i,s,a){var r="No URL found for this questionnaire. Web link collector may not be configured yet.";r='<p class="url_error"><span class="label label-danger">Error</span> '+r+" </p>",l.html(r);var o=$('<a href="#" class="retry">Retry</a>');o.click(function(i){i.preventDefault(),surveyLink.checkSurveyAssignment(e,n,function(){surveyLink.setQnaIds(e,n,function(){surveyLink.selectSurvey(e,n,t)})})}),l.find("p").append(o)},complete:function(){s.prop("disabled",!1),e.find(".loading").remove()}})}},surveyOverview={community_id:null,init:function(e){this.community_id=e.community_id,this.setupImport(),$(".invitations_toggler").click(function(e){e.preventDefault(),$(this).closest("div.panel-body").find(".invitations_list").slideToggle()})},setupImport:function(){var e=$("#import-results");if(e.is(":empty"))e.hide();else{var n=e.find("ul"),t=$('<button class="btn btn-default btn-sm">Show errors</button>');t.click(function(e){e.preventDefault(),n.slideToggle()}),n.before(t),n.hide()}$(".import_button").click(function(n){n.preventDefault();var t=$(this);t.hasClass("disabled")||importResponses(t,e)})}},importResponses=function(e,n){var t=e.data("survey-id");$.ajax({url:"/surveys/import/"+t,beforeSend:function(){e.addClass("disabled");var t=$('<img src="/data_center/img/loading_small.gif" class="loading" />');e.append(t),n.is(":visible")&&n.slideUp(200)},success:function(e){n.addClass("alert").addClass("alert-success").removeClass("alert-danger"),n.html(e),n.slideDown()},error:function(e,t,i){n.addClass("alert").addClass("alert-danger").removeClass("alert-success"),n.html(e.responseText),n.slideDown()},complete:function(){e.removeClass("disabled"),e.find(".loading").remove(),e.parent().children(".last_import_time").html("Responses were last imported a moment ago")}})},clearResponses=function(e,n){var t=e.data("survey-id");$.ajax({url:"/admin/surveys/clear-responses/"+t+".json",beforeSend:function(){e.addClass("disabled");var t=$('<img src="/data_center/img/loading_small.gif" class="loading" />');e.append(t),n.is(":visible")&&n.slideUp(200)},success:function(e){n.addClass("alert"),e.success?(n.addClass("alert-success").removeClass("alert-danger"),n.html("Responses cleared")):(n.addClass("alert-danger").removeClass("alert-success"),n.html("Error clearing responses")),n.slideDown()},error:function(e,t,i){n.addClass("alert").addClass("alert-danger").removeClass("alert-success"),n.html("Error clearing responses"),n.slideDown()},complete:function(){e.removeClass("disabled"),e.find(".loading").remove()}})},adminHeader={communityId:null,surveyId:null,surveyIds:[],init:function(e){this.communityId=e.communityId,this.surveyId=e.surveyId,this.surveyIds=e.surveyIds,this.surveyType=e.surveyType,this.selectCommunity(this.communityId),this.selectPage(e.currentUrl),$("#admin-sidebar-community").submit(function(e){e.preventDefault();var n=adminHeader.getUrl();n&&(adminHeader.removeError(),window.location.href=n)})},getUrl:function(){var e=$("#admin-sidebar-community select[name=community]").val();if(!e)return this.displayError("Please select a community"),!1;var n=$("#admin-sidebar-community select[name=page] option:selected"),t=n.val();if(!t)return this.displayError("Please select a page"),!1;var i=t.replace("{community-id}",e),s=n.closest("optgroup").data("survey-type");s&&(i=i.replace("{survey-type}",s));var a=this.getSurveyId(e,s);if(a)i=i.replace("{survey-id}",a);else if(i.search("{survey-id}")!=-1){var r=$("#admin-sidebar-community select[name=community] option:selected").text().trim(),o="The "+s+" questionnaire has not yet been set up for "+r+".";return this.displayError(o),!1}return i},getSurveyId:function(e,n){if(!e||!n)return!1;if(this.surveyIds.hasOwnProperty(e)){if(adminHeader.surveyIds[e].hasOwnProperty(n))return this.surveyIds[e][n]}return!1},displayError:function(e){var n=$('<p class="admin-header-error alert alert-info">'+e+"</p>");n.hide();var t=$("#admin-sidebar-community"),i=t.find(".admin-header-error");i.length>0?i.fadeOut(300,function(){i.remove(),t.append(n),n.fadeIn(300)}):(t.append(n),n.fadeIn(300)),setTimeout(function(){adminHeader.removeError()},5e3)},removeError:function(){var e=$("#admin-sidebar-community .admin-header-error");e.length&&e.slideUp(300,function(){e.remove()})},selectCommunity:function(e){$("#admin-sidebar-community select[name=community]").val(e)},selectPage:function(e){$("#admin-sidebar-community select[name=page] optgroup").each(function(){var n=$(this),t=n.data("survey-type");n.find("option").each(function(){var n=$(this),i=n.val();if(i){if("/admin/communities/clienthome/{community-id}"==i&&"/client/home"==e)return void n.prop("selected",!0);var s=i.replace("{community-id}",adminHeader.communityId);if(s.search("{survey-id}")!=-1){var a=adminHeader.getSurveyId(adminHeader.communityId,t);if(!a)return;s=s.replace("{survey-id}",a)}e==s&&n.prop("selected",!0)}})})}};jQuery.fn.sortElements=function(){var e=[].sort;return function(n,t){t=t||function(){return this};var i=this.map(function(){var e=t.call(this),n=e.parentNode,i=n.insertBefore(document.createTextNode(""),e.nextSibling);return function(){if(n===this)throw new Error("You can't sort elements if any one is a descendant of another.");n.insertBefore(this,i),n.removeChild(i)}});return e.call(this,n).each(function(e){i[e].call(t.call(this))})}}();var presentationsForm={init:function(){$("#presentations-form input[type=radio]").change(function(){presentationsForm.toggleDate($(this).closest("section"))})},toggleDate:function(e){var n=e.find("div.date");e.find("input[value=1]").is(":checked")?n.is(":visible")||n.slideDown():n.is(":visible")&&n.slideUp()}},adminGuide={init:function(){for(var e=$("section.admin-guide"),n=function(){var e=$(this).parents("section");adminGuide.toggleSection(e)},t=0;t<e.length;t++){var i=$(e[t]),s=i.find("h2"),a=$('<button class="btn btn-default btn-block"></button>');a.click(n),s.wrapInner(a)}},toggleSection:function(e){e.find("h2").next().slideToggle()}},activityRecords={init:function(){$("#activity-records tr.details > td > div").each(function(){var e=$(this),n=$('<button class="btn btn-link"></button>');n.click(function(n){n.preventDefault(),e.slideToggle()}),e.parents("tr").prev().find("td:first-child").wrapInner(n)}),$("#activity-records-intro button").click(function(e){e.preventDefault(),$("#activities-tracked").slideToggle()})}},alignmentCalculationSettings={init:function(){$('#filter-by-community input[type="text"]').bind("change paste keyup",function(){var e=$(this).val();alignmentCalculationSettings.filter(e)})},filter:function(e){e=e.toLowerCase();var n=$("#alignmentCalcSettings tbody tr").not(".default");if(""===e)return void n.show();n.each(function(){var n=$(this);n.find("td:first-child").text().trim().toLowerCase().search(e)==-1?n.hide():n.show()})}};