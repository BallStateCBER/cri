function getRandomPassword(){for(var e="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=0;5>t;t++)e+=n.charAt(Math.floor(Math.random()*n.length));return e}var adminUserEdit={community_counter:0,init:function(e){var n=$('<ul id="community_container"></ul>'),t=$("#community");if(t.after(n),t.prop("selectedIndex",0),e.selected_communities.length>0)for(var i=0;i<e.selected_communities.length;i++){var a=e.selected_communities[i];this.addCommunity(a.id,a.name,!1)}t.change(function(){var e=$(this),n=e.val(),t=$('li[data-community-id="'+n+'"]');if(0===t.length){var i=e.find("option:selected").text();adminUserEdit.addCommunity(n,i,!0)}e.prop("selectedIndex",0)}),$("#all-communities-0, #all-communities-1").change(function(){adminUserEdit.toggleAllCommunities(!0)}),this.toggleAllCommunities(!1),$("#role").change(function(){adminUserEdit.onRoleChange(!0)}),this.onRoleChange(!1),$("#password-fields-button a").click(function(e){e.preventDefault(),$("#password-fields-button").slideUp(300),$("#password-fields").slideDown(300)})},addCommunity:function(e,n,t){var i=$('<li data-community-id="'+e+'"></li>'),a=$('<a href="#"><span class="glyphicon glyphicon-remove"></span> <span class="link_label">'+n+"</span></a>");a.click(function(e){e.preventDefault(),i.slideUp(300,function(){i.remove()})}),i.append(a),i.append('<input type="hidden" name="consultant_communities['+this.community_counter+'][id]" value="'+e+'" />'),this.community_counter++,t&&i.hide(),$("#community_container").prepend(i),t&&i.slideDown()},toggleAllCommunities:function(e){$("#all-communities-0").is(":checked")?e?($("#community").slideDown(),$("#community_container").slideDown()):($("#community").show(),$("#community_container").show()):e?($("#community").slideUp(),$("#community_container").slideUp()):($("#community").hide(),$("#community_container").hide())},onRoleChange:function(e){var n=$("#role").val(),t=e?300:0;"consultant"==n?($("#consultant_communities").slideDown(t),$("#client_communities").slideUp(t)):"client"==n?($("#client_communities").slideDown(t),$("#consultant_communities").slideUp(t)):($("#consultant_communities").slideUp(t),$("#client_communities").slideUp(t))}},communityForm={community_id:null,client_counter:0,consultant_counter:0,init:function(e){this.community_id=e.community_id,this.setupSurveyLinking(),this.setupAssociatedUserInterface(e.selected_clients,e.selected_consultants),$("#CommunityMeetingDateSet0, #CommunityMeetingDateSet1").change(function(){communityForm.toggleDateFields(!0)}),this.toggleDateFields(!1),$("#CommunityAdminEditForm").submit(function(e){var n=null;$("#client_add").is(":visible")&&(""!==$("#NewClientEntryName").val()||""!==$("#NewClientEntryEmail").val())&&(n=$("#client_add button").html().trim(),alert('To add a new client, click "'+n+'"'),e.preventDefault()),$("#consultant_add").is(":visible")&&(""!==$("#NewConsultantEntryName").val()||""!==$("#NewConsultantEntryEmail").val())&&(n=$("#consultant_add button").html().trim(),alert('To add a new consultant, click "'+n+'"'),e.preventDefault())}),$(document).keypress(function(e){var n=e.keyCode?e.keyCode:e.which;13==n&&(1==$("#client_add input:focus").length&&(communityForm.addNewUser("client"),e.preventDefault(),e.stopPropagation()),1==$("#consultant_add input:focus").length&&(communityForm.addNewUser("consultant"),e.preventDefault(),e.stopPropagation()))})},toggleDateFields:function(e){$("#CommunityMeetingDateSet0").is(":checked")&&(e?$("#meeting_date_fields").slideUp():$("#meeting_date_fields").hide()),$("#CommunityMeetingDateSet1").is(":checked")&&(e?$("#meeting_date_fields").slideDown():$("#meeting_date_fields").show())},setupSurveyLinking:function(){$(".link_survey").each(function(){var e=$(this);e.find("a.lookup").click(function(n){n.preventDefault();var t=e.find(".lookup_results");t.is(":visible")?t.slideUp():communityForm.lookupUrl(e)}),e.find("a.show_details").click(function(n){n.preventDefault(),e.find(".details").slideToggle()})})},setupAssociatedUserInterface:function(e,n){$(".toggle_add").click(function(e){e.preventDefault();var n=$(this).data("user-type");communityForm.toggleAddUser(n)}),$(".toggle_select").click(function(e){e.preventDefault();var n=$(this).data("user-type");communityForm.toggleSelectUser(n)}),$("#client_interface > .panel-body").append('<ul id="client_list"></ul>'),$("#consultant_interface > .panel-body").append('<ul id="consultant_list"></ul>'),$(window).keydown(function(e){if(13==e.keyCode){var n=$("#client_add input:focus, #consultant_add input:focus").length>0;if(n)return e.preventDefault(),!1}}),$("#client_add button, #consultant_add button").click(function(e){e.preventDefault();var n=$(this).data("userType");communityForm.addNewUser(n)}),$("#CommunityClientId, #CommunityConsultantId").each(function(){$(this).selectedIndex=-1,$(this).change(function(){var e=$(this),n=e.val(),t=e.data("user-type");if(n){var i=$('li[data-user-id="'+n+'"]');if(0===i.length){var a=e.find("option:selected").text();communityForm.addExistingUser(t,n,a,!0)}e.prop("selectedIndex",0),e.is(":visible")&&communityForm.toggleSelectUser(t)}})});var t=0,i=null;if(e.length>0)for(t=0;t<e.length;t++)i=e[t],this.addExistingUser("client",i.id,i.name,!1);if(n.length>0)for(t=0;t<n.length;t++)i=n[t],this.addExistingUser("consultant",i.id,i.name,!1)},addExistingUser:function(e,n,t,i){var a=$('<li data-user-id="'+n+'"></li>'),s=$('<a href="#"><span class="user_name">'+t+'</span> <span class="remove">Remove</span></a>');s.click(function(e){e.preventDefault(),a.slideUp(300,function(){a.remove()})}),a.append(s);var l="client"==e?"Client":"Consultant",o="client"==e?this.client_counter:this.consultant_counter;a.append('<input type="hidden" name="data['+l+"]["+o+']" value="'+n+'" />'),"client"==e?this.client_counter++:this.consultant_counter++,i&&a.hide(),$("#"+e+"_list").prepend(a),i&&a.slideDown()},addNewUser:function(e){var n="client"==e?"NewClient":"NewConsultant",t="client"==e?this.client_counter:this.consultant_counter,i=$("#"+n+"EntryName"),a=$("#"+n+"EntryTitle"),s=$("#"+n+"EntryOrganization"),l=$("#"+n+"EntryEmail"),o=$("#"+n+"EntryPhone"),r=$("#"+n+"EntryPassword");if(!i.val())return void alert("Please enter this user's name.");if(!l.val())return void alert("Please enter this user's email address.");if(!r.val())return void alert("Please enter a password for this user.");var c=$("<li></li>"),u=$('<a href="#"><span class="user_name">'+i.val()+'</span> <span class="remove">Remove</span></a>');u.click(function(e){e.preventDefault(),c.slideUp(300,function(){c.remove()})}),c.append(u),c.append('<input type="hidden" name="data['+n+"]["+t+'][name]" value="'+i.val()+'" />'),c.append('<input type="hidden" name="data['+n+"]["+t+'][title]" value="'+a.val()+'" />'),c.append('<input type="hidden" name="data['+n+"]["+t+'][organization]" value="'+s.val()+'" />'),c.append('<input type="hidden" name="data['+n+"]["+t+'][email]" value="'+l.val()+'" />'),c.append('<input type="hidden" name="data['+n+"]["+t+'][phone]" value="'+o.val()+'" />'),c.append('<input type="hidden" name="data['+n+"]["+t+'][password]" value="'+r.val()+'" />'),"client"==e?this.client_counter++:this.consultant_counter++,c.hide(),$("#"+e+"_list").prepend(c),c.slideDown(),i.val(""),l.val(""),r.val(""),a.val(""),s.val(""),o.val(""),this.toggleAddUser(e)},toggleAddUser:function(e){var n=$("#"+e+"_add"),t=$("#"+e+"_select");if(t.is(":visible")&&t.slideUp(),n.is(":visible"))n.slideUp();else{var i=getRandomPassword();"client"==e?$("#NewClientEntryPassword").val(i):$("#NewConsultantEntryPassword").val(i),n.slideDown()}},toggleSelectUser:function(e){var n=$("#"+e+"_add"),t=$("#"+e+"_select");n.is(":visible")&&n.slideUp(),t.is(":visible")?t.slideUp():t.slideDown()},lookupUrl:function(e){var n=e.find("a.lookup"),t="/surveys/get_survey_list",i=e.find(".lookup_results");$.ajax({url:t,beforeSend:function(){n.addClass("disabled");var e=$('<img src="/data_center/img/loading_small.gif" alt="Loading..." />');n.append(e)},success:function(n){function t(n){return function(){n.preventDefault();var t=$(this).data("survey-id"),i=$(this).data("survey-url");communityForm.checkSurveyAssignment(e,t,function(){communityForm.setQnaIds(e,t,function(){communityForm.selectSurvey(e,t,i)})})}}if(n=jQuery.parseJSON(n),i.empty(),0===n.length)return void i.append('<p class="alert alert-danger">Error: No surveys found</p>');i.append("<p>Please select the correct SurveyMonkey survey:</p>");for(var a=$("<ul></ul>"),s=0;s<n.length;s++){var l=n[s].sm_id,o=n[s].url,r=n[s].title,c=$('<a href="#" data-survey-id="'+l+'" data-survey-url="'+o+'">'+r+"</a>");c.click(t(event));var u=$("<li></li>").append(c);a.append(u)}i.append(a),i.slideDown()},error:function(){i.append('<p class="alert alert-danger">Error: No surveys found</p>')},complete:function(){n.removeClass("disabled"),n.children("img").remove()}})},checkSurveyAssignment:function(e,n,t){var i=(e.find("input.survey_url"),e.find(".link_label")),a=e.find(".link_status");$.ajax({url:"/surveys/check_survey_assignment/"+n,dataType:"json",beforeSend:function(){var e='<span class="loading"><img src="/data_center/img/loading_small.gif" /> Checking survey uniqueness...</span>';i.html(e)},success:function(e){e[0]&&e[0]!=communityForm.community_id?(i.html('<span class="label label-danger">Error</span>'),a.html('<span class="url_error">That survey is already assigned to another community: <a href="/admin/communities/edit/'+e[0]+'">'+e[1]+"</a></span>")):(i.html(" "),t())},error:function(s,l,o){i.html('<span class="label label-danger">Error</span>'),a.html('<span class="url_error">Error checking survey uniqueness</span>');var r=$('<a href="#" class="retry">Retry</a>');r.click(function(i){i.preventDefault(),communityForm.checkSurveyAssignment(e,n,t)}),a.append(r)}})},setQnaIds:function(e,n,t){var i=e.find(".link_label"),a=function(a){var s=e.find(".link_status"),l=$('<a href="#" class="retry">Retry</a>');l.click(function(i){i.preventDefault(),communityForm.setQnaIds(e,n,t)}),i.html('<span class="label label-danger">Error</span>'),s.html('<span class="url_error">'+a+"</span>"),s.append(l)};$.ajax({url:"/surveys/get_qna_ids/"+n,beforeSend:function(){var e='<span class="loading"><img src="/data_center/img/loading_small.gif" /> Extracting PWR<sup>3</sup> question info...</span>';i.html(e)},success:function(n){n=jQuery.parseJSON(n);var i=n[0];if(i){var s=n[2];for(var l in s){var o=e.find("input[data-fieldname='"+l+"']"),r=s[l];o.val(r)}t()}else{var c=n[1];a(c)}},error:function(e,n,t){a("Error extracting PWR<sup>3</sup> question info")},complete:function(){e.find(".loading").remove()}})},selectSurvey:function(e,n,t){var i=e.find(".lookup_results");i.is(":visible")&&i.slideUp(),e.find(".url_error, .retry").remove();var a=e.find("input.survey_sm_id");a.val(n);var s=e.find("input.survey_url"),l=e.find(".link_label"),o=e.find(".link_status");return t?(s.val(t),l.html('<span class="label label-success">Linked</span>'),void o.html('<a href="'+t+'">'+t+"</a>")):(s.val(""),void $.ajax({url:"/surveys/get_survey_url/"+n,beforeSend:function(){s.prop("disabled",!0);var e='<span class="loading"><img src="/data_center/img/loading_small.gif" /> Retrieving URL...</span>';l.html(e)},success:function(e){s.val(e),l.html('<span class="label label-success">Linked</span>'),o.html('<a href="'+e+'">'+e+"</a>")},error:function(i,a,s){l.html('<span class="label label-danger">Error</span>');var r=-1!=i.responseText.indexOf(r)?'<span class="url_error">No URL found for this survey. Web link collector may not be configured yet.</span>':'<span class="url_error">Error looking up URL</span>';o.html(r);var c=$('<a href="#" class="retry">Retry</a>');c.click(function(i){i.preventDefault(),communityForm.checkSurveyAssignment(e,n,function(){communityForm.setQnaIds(e,n,function(){communityForm.selectSurvey(e,n,t)})})}),o.append(c)},complete:function(){s.prop("disabled",!1),e.find(".loading").remove()}}))}},adminSurveysIndex={init:function(){$("#surveys_admin_index .help_toggler").click(function(e){e.preventDefault(),$("#surveys_admin_index .help_message").slideToggle()})}},adminViewResponses={init:function(){$("#admin_responses_view .respondent_popup_handle").click(function(e){e.preventDefault(),$(this).siblings(".respondent_popup").toggle()}),$(".custom_alignment_calc").change(function(){var e=$("tfoot td.selected"),n=0,t=$(".custom_alignment_calc:checked");t.each(function(){var e=$(this).data("alignment");n=e+n});var i=t.length,a=i?Math.round(n/i):0;e.html(a+"%")}),$("#toggle_custom_calc").click(function(e){e.preventDefault(),$("td.selected, th.selected").toggle()})}},adminCommunitiesIndex={init:function(){$("a.survey_link_toggler").click(function(e){e.preventDefault(),$(this).siblings(".survey_links").slideToggle(200)}),$("#search_toggler").click(function(e){e.preventDefault();var n=$("#admin_community_search_form");n.is(":visible")?n.slideUp():(n.slideDown(),n.children("input").focus())}),$('#admin_community_search_form input[type="text"]').autocomplete({source:"/communities/autocomplete",minLength:2,select:function(e,n){$('#admin_community_search_form input[type="text"]').val(n.item.label);var t=' <img src="/data_center/img/loading_small.gif" class="loading" />';$("#admin_community_search_form button").append(t).addClass("disabled"),$("#admin_community_search_form form").submit()},search:function(e,n){var t='<img src="/data_center/img/loading_small.gif" class="loading" />';$("#admin_community_search_form button").after(t)},response:function(e,n){$("#admin_community_search_form .loading").remove()}}),$("#glossary_toggler").click(function(e){e.preventDefault(),$("#glossary").slideToggle()})}};